<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amelo Studio Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
    /* Shared responsive rules for dashboard pages */
    #sidebar { transition: transform .25s ease; }
    @media (max-width: 900px) {
      #sidebar { transform: translateX(-100%); position: fixed; left:0; top:0; bottom:0; z-index:40;}
      #sidebar.open { transform: translateX(0); }
      #sidebar.pinned { transform: translateX(0); } /* pinned shows sidebar */
      #mainContent { margin-left: 0 !important; padding: 1rem !important; }
      .mobile-tap { padding: 12px; font-size: 16px; }
    }

    /* Sidebar tab (mobile): small handle to open the sidebar */
    .sidebar-tab {
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      background: #0f172a;
      color: #fff;
      width: 42px;
      height: 88px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-top-right-radius: 10px;
      border-bottom-right-radius: 10px;
      z-index: 10002;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .sidebar-pin-btn {
      background: transparent;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 18px;
    }

    /* Modern action menu & badges */
    .card-header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .badge { padding:4px 8px; border-radius:999px; font-size:12px; color:#fff; }
    .badge.gray { background:#6b7280; } /* en progreso */
    .badge.blue { background:#2563eb; } /* terminado */
    .badge.green { background:#16a34a; } /* pagado */
    .badge.yellow { background:#d97706; } /* no pagado */

    .card-actions { position:relative; }
    .action-btn {
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      color: #374151;
    }
    .action-list {
      position: absolute;
      right: 0;
      top: 28px;
      background: #fff;
      border: 1px solid rgba(15,23,42,0.06);
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.08);
      min-width: 180px;
      display: none;
      z-index: 50;
      overflow: hidden;
    }
    .action-list.open { display: block; }
    .action-list button {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 8px 12px;
      background: transparent;
      border: none;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: #111827;
    }
    .action-list button:hover { background: #f8fafc; }

    /* Mobile tweaks for cards, badges, actions and filters */
    @media (max-width: 640px) {
      /* Make card header stack vertically */
      .card-header {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      .card-header > div:first-child { /* title block full width */
        width: 100%;
      }
      /* Actions row aligned right but full-width container */
      .card-actions { width: 100%; display:flex; justify-content:flex-end; }
      .action-btn { font-size: 20px; padding: 8px; }
      /* Show action list as full-width block below the button on mobile */
      .action-list {
        position: static;
        right: auto;
        top: auto;
        margin-top: 8px;
        width: 100%;
        border-radius: 8px;
        box-shadow: none;
        border: 1px solid rgba(15,23,42,0.06);
      }
      .action-list button { padding: 12px 14px; font-size: 15px; }

      /* Smaller badges, better spacing */
      .badge { font-size: 11px; padding: 3px 8px; }

      /* Filters: allow wrapping and full-width inputs */
      .mb-6 .flex.items-center { flex-wrap: wrap; gap: 8px; }
      #filterSelect, #searchInput { min-width: 120px; }
      @media (max-width: 420px) {
        #filterSelect, #searchInput { width: 100%; min-width: 0; }
        .mb-6 { gap: 10px; }
      }

      /* Card text slightly larger for readability on touch */
      .card-header h3 { font-size: 1.05rem; }
      .card-header p { font-size: 0.95rem; }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">

<!-- Sidebar -->
<aside id="sidebar" class="w-64 bg-white h-screen shadow-md fixed">
  <div class="p-6 text-2xl font-bold text-blue-600 flex items-center justify-between">
    <span>Amelo Studio</span>
    <button id="sidebarPinBtn" class="sidebar-pin-btn" title="Fijar menú">📌</button>
  </div>
  <nav class="mt-10">
    <a href="#" class="block py-2.5 px-4 rounded hover:bg-blue-100">Dashboard</a>
    <a href="calendar.html" class="block py-2.5 px-4 rounded hover:bg-blue-100">Calendario</a>
    <a href="config.html" class="block py-2.5 px-4 rounded hover:bg-blue-100">Configuración</a>
  </nav>
</aside>

<!-- Sidebar tab: visible en móvil para abrir el menú -->
<button id="sidebarTab" class="sidebar-tab md:hidden" aria-label="Abrir menú">☰</button>

<div id="mainContent" class="ml-64 p-8">

  <!-- Header -->
  <header class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
      <button id="mobileMenuBtn" class="md:hidden p-2 rounded bg-gray-100 mobile-tap" aria-label="Abrir menú">
        <ion-icon name="menu-outline"></ion-icon>
      </button>
      <h1 class="text-2xl font-bold">Dashboard</h1>
    </div>
    <div>
      <span class="mr-4">Admin</span>
      <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Cerrar sesión</button>
    </div>
  </header>

  <!-- Estadísticas -->
  <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded shadow hover:shadow-lg transition text-center">
      <h2 class="text-lg font-semibold text-gray-600">Clientes Totales</h2>
      <p id="totalClients" class="text-3xl font-bold text-blue-600 mt-2">0</p>
    </div>
    <div class="bg-white p-6 rounded shadow hover:shadow-lg transition text-center">
      <h2 class="text-lg font-semibold text-gray-600">Ganancias Generadas</h2>
      <p id="totalRevenue" class="text-3xl font-bold text-green-600 mt-2">$0</p>
    </div>
    <div class="bg-white p-6 rounded shadow hover:shadow-lg transition text-center">
      <h2 class="text-lg font-semibold text-gray-600">Ganancias Amelo</h2>
      <p id="ameloRevenue" class="text-3xl font-bold text-green-600 mt-2">$0</p>
    </div>
    <div class="bg-white p-6 rounded shadow hover:shadow-lg transition text-center">
      <h2 class="text-lg font-semibold text-gray-600">Pagos Pendientes</h2>
      <p id="pendingPayments" class="text-3xl font-bold text-yellow-500 mt-2">0</p>
    </div>
  </section>

  <!-- Agregar cliente + filtros -->
  <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div class="flex items-center gap-3">
      <h2 class="text-2xl font-semibold text-gray-700 mr-2">Clientes</h2>
      <select id="filterSelect" class="border rounded p-2 text-sm">
        <option value="all">Mostrar: Todos</option>
        <option value="completed">Terminados</option>
        <option value="not_completed">No terminados</option>
        <option value="paid">Pagados</option>
        <option value="not_paid">No pagados</option>
      </select>
      <input id="searchInput" type="text" placeholder="Buscar cliente o proyecto..." class="border rounded p-2 text-sm ml-2" />
      <button id="clearFiltersBtn" class="ml-2 px-3 py-2 rounded bg-gray-200 text-sm">Limpiar</button>
    </div>
    <button id="addClientBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">+ Agregar Cliente</button>
  </div>

  <div id="clientContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</div>

<!-- Modal Agregar / Editar Cliente -->
<div id="clientModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
  <div class="bg-white p-6 rounded shadow-lg w-96">
    <h2 id="modalTitle" class="text-xl font-semibold mb-4">Agregar Cliente</h2>
    <form id="clientForm" class="flex flex-col gap-3">
      <input type="text" id="clientName" placeholder="Nombre" class="p-2 border rounded" required>
      <input type="text" id="projectName" placeholder="Nombre del Proyecto" class="p-2 border rounded" required>
      <input type="url" id="repoLink" placeholder="Link del repositorio (https://github.com/...)" class="p-2 border rounded" required>
      <input type="text" id="nextPayment" placeholder="Próximo pago (dd/mm/yyyy)" class="p-2 border rounded">
      <input type="number" id="paymentAmount" placeholder="Precio a pagar" class="p-2 border rounded" required step="0.01">
      <input type="number" id="ameloAmount" placeholder="Monto que va a Amelo" class="p-2 border rounded" required step="0.01">
      <!-- Nuevo: estado de proyecto -->
      <label class="flex items-center gap-2">
        <input type="checkbox" id="projectCompleted" />
        Proyecto terminado
      </label>
      <textarea id="notes" placeholder="Notas" class="p-2 border rounded"></textarea>
      <div class="flex justify-end gap-2 mt-2">
        <button type="button" id="closeClientModal" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancelar</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
  // --- Firebase ---
  const firebaseConfig = {
     apiKey: "AIzaSyBnIUBoaMViSI2jHGPD9NoJaJrTQiL-UFU",

  authDomain: "amelos-studio.firebaseapp.com",

  databaseURL: "https://amelos-studio-default-rtdb.firebaseio.com",

  projectId: "amelos-studio",

  storageBucket: "amelos-studio.firebasestorage.app",

  messagingSenderId: "11496902615",

  appId: "1:11496902615:web:33ce1c36199e7c17be8592",

  measurementId: "G-DR054GPPZF"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const clientsRef = db.ref('clients');

  // --- Elementos ---
  const addClientBtn = document.getElementById('addClientBtn');
  const clientModal = document.getElementById('clientModal');
  const closeClientModal = document.getElementById('closeClientModal');
  const clientContainer = document.getElementById('clientContainer');
  const totalClients = document.getElementById('totalClients');
  const totalRevenue = document.getElementById('totalRevenue');
  const ameloRevenue = document.getElementById('ameloRevenue');
  const pendingPayments = document.getElementById('pendingPayments');
  const clientForm = document.getElementById('clientForm');
  const modalTitle = document.getElementById('modalTitle');

  // nuevos elementos de filtro/búsqueda
  const filterSelect = document.getElementById('filterSelect');
  const searchInput = document.getElementById('searchInput');
  const clearFiltersBtn = document.getElementById('clearFiltersBtn');

  let clients = [];
  let editKey = null;

  // --- Mostrar/ocultar modal ---
  addClientBtn.addEventListener('click', () => {
    modalTitle.textContent = "Agregar Cliente";
    clientForm.reset();
    editKey = null;
    clientModal.classList.remove('hidden');
    clientModal.classList.add('flex');
  });
  closeClientModal.addEventListener('click', () => {
    clientModal.classList.add('hidden');
    clientModal.classList.remove('flex');
  });

  // --- Cargar clientes ---
  clientsRef.on('value', snapshot => {
    clients = [];
    snapshot.forEach(child => {
      const client = child.val();
      client.key = child.key;
      clients.push(client);
    });
    renderClients();
  });

  // --- Agregar / Editar ---
  clientForm.addEventListener('submit', e => {
    e.preventDefault();
    const name = document.getElementById('clientName').value;
    const project = document.getElementById('projectName').value;
    const repo = extractRepoPath(document.getElementById('repoLink').value);
    const nextPayment = document.getElementById('nextPayment').value || 'No definido';
    const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
    const ameloAmount = parseFloat(document.getElementById('ameloAmount').value);
    const completed = !!document.getElementById('projectCompleted').checked;
    const notes = document.getElementById('notes').value;
    const clientData = { name, project, repo, nextPayment, paymentAmount, ameloAmount, notes, paid: false, completed };

    if(editKey) {
      clientsRef.child(editKey).set(clientData);
    } else {
      clientsRef.push(clientData);
    }

    clientModal.classList.add('hidden');
    clientModal.classList.remove('flex');
  });

  function extractRepoPath(link) {
    try { return link.split("github.com/")[1].replace(/\/$/,""); }
    catch { return ""; }
  }

  function deleteClient(index) {
    const key = clients[index].key;
    clientsRef.child(key).remove();
  }

  function editClient(index) {
    const c = clients[index];
    editKey = c.key;
    modalTitle.textContent = "Editar Cliente";
    document.getElementById('clientName').value = c.name;
    document.getElementById('projectName').value = c.project;
    document.getElementById('repoLink').value = `https://github.com/${c.repo}`;
    document.getElementById('nextPayment').value = c.nextPayment;
    document.getElementById('paymentAmount').value = c.paymentAmount;
    document.getElementById('ameloAmount').value = c.ameloAmount;
    document.getElementById('projectCompleted').checked = !!c.completed;
    document.getElementById('notes').value = c.notes;
    clientModal.classList.remove('hidden');
    clientModal.classList.add('flex');
  }

  // Alternar estado "Proyecto terminado"
  function toggleCompleted(index) {
    const c = clients[index];
    const newState = !c.completed;
    clientsRef.child(c.key).update({ completed: newState });
  }
  window.toggleCompleted = toggleCompleted; // exponer para onclick en HTML generado

  // Alternar estado "Pagado / No Pagado"
  function togglePaid(index) {
    const c = clients[index];
    if (!c) return;
    const newPaid = !c.paid;
    clientsRef.child(c.key).update({ paid: newPaid });
  }
  window.togglePaid = togglePaid;

  // Reemplazar renderClients con diseño más moderno (menos botones visibles)
  function renderClients() {
    clientContainer.innerHTML = "";
    let totalRev = 0, ameloRev = 0, pending = 0;

    // obtener filtros actuales
    const filter = filterSelect ? filterSelect.value : 'all';
    const q = searchInput && searchInput.value ? searchInput.value.trim().toLowerCase() : '';

    // recorrer con índices originales para mantener mapping de acciones
    clients.forEach((c, index) => {
      // calculos globales (estadísticas)
      if (c.paid) {
        totalRev += c.paymentAmount || 0;
        ameloRev += c.ameloAmount || 0;
      } else {
        pending++;
      }

      // aplicar filtro por tipo
      if (filter === 'completed' && !c.completed) return;
      if (filter === 'not_completed' && c.completed) return;
      if (filter === 'paid' && !c.paid) return;
      if (filter === 'not_paid' && c.paid) return;

      // aplicar búsqueda por nombre o proyecto
      if (q) {
        const hay = (c.name || '').toLowerCase().includes(q) || (c.project || '').toLowerCase().includes(q);
        if (!hay) return;
      }

      const card = document.createElement('div');
      card.className = "bg-white p-6 rounded shadow hover:shadow-lg transition relative";

      const paidLabel = c.paid ? 'Pagado' : 'No Pagado';
      const paidBadgeClass = c.paid ? 'badge green' : 'badge yellow';
      const completedLabel = c.completed ? 'Terminado' : 'En progreso';
      const completedBadgeClass = c.completed ? 'badge blue' : 'badge gray';

      card.innerHTML = `
        <div class="card-header">
          <div>
            <h3 class="text-lg font-semibold text-gray-800">Cliente: ${c.name}</h3>
            <p class="text-sm text-gray-600">${c.project}</p>
          </div>

          <div style="display:flex;align-items:center;gap:8px;">
            <span class="${completedBadgeClass}">${completedLabel}</span>
            <span class="${paidBadgeClass}">${paidLabel}</span>

            <div class="card-actions">
              <button class="action-btn" data-index="${index}" aria-expanded="false" title="Acciones">⋮</button>
              <div class="action-list" data-index="${index}" aria-hidden="true">
                <button data-action="edit" data-index="${index}">✏️ Editar</button>
                <button data-action="togglePaid" data-index="${index}">${c.paid ? '↩️ Marcar No Pagado' : '✅ Marcar Pagado'}</button>
                <button data-action="toggleCompleted" data-index="${index}">${c.completed ? '↩️ Marcar No terminado' : '🏁 Marcar terminado'}</button>
                <button data-action="delete" data-index="${index}" style="color:#dc2626">🗑️ Eliminar</button>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4 text-sm text-gray-600">
          <p>Próximo pago: ${c.nextPayment}</p>
          <p>Pago: $${c.paymentAmount.toFixed(2)} · Amelo: $${c.ameloAmount.toFixed(2)}</p>
          <p class="mt-2 text-gray-500">Notas: ${c.notes || 'Ninguna'}</p>
        </div>
      `;
      clientContainer.appendChild(card);
    });

    totalClients.textContent = clients.length;
    totalRevenue.textContent = `$${totalRev.toFixed(2)}`;
    ameloRevenue.textContent = `$${ameloRev.toFixed(2)}`;
    pendingPayments.textContent = pending;
  }

  // Delegación: manejar clicks en el menú de acciones
  document.addEventListener('click', function(e){
    // Toggle action list
    const actionBtn = e.target.closest('.action-btn');
    if (actionBtn) {
      const idx = actionBtn.getAttribute('data-index');
      const list = document.querySelector('.action-list[data-index="'+idx+'"]');
      if (list) {
        const open = list.classList.toggle('open');
        list.setAttribute('aria-hidden', open ? 'false' : 'true');
      }
      // close other menus
      document.querySelectorAll('.action-list').forEach(l=>{
        if (l.getAttribute('data-index') !== idx) { l.classList.remove('open'); l.setAttribute('aria-hidden','true'); }
      });
      return;
    }

    // Action item clicked
    const act = e.target.closest('.action-list button');
    if (act) {
      const action = act.getAttribute('data-action');
      const idx = parseInt(act.getAttribute('data-index'), 10);
      if (typeof idx === 'number' && !isNaN(idx)) {
        if (action === 'edit') editClient(idx);
        else if (action === 'togglePaid') togglePaid(idx);
        else if (action === 'toggleCompleted') toggleCompleted(idx);
        else if (action === 'delete') {
          if (confirm('¿Eliminar este cliente?')) deleteClient(idx);
        }
      }
      // close all menus
      document.querySelectorAll('.action-list').forEach(l=> { l.classList.remove('open'); l.setAttribute('aria-hidden','true'); });
      return;
    }

    // Click fuera: cerrar menús
    if (!e.target.closest('.card-actions')) {
      document.querySelectorAll('.action-list').forEach(l=> { l.classList.remove('open'); l.setAttribute('aria-hidden','true'); });
    }
  });

  // mobile sidebar toggle for mainboard
  (function(){
    const mobileBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('sidebar');
    const main = document.getElementById('mainContent');
    const sidebarTab = document.getElementById('sidebarTab');
    const sidebarPinBtn = document.getElementById('sidebarPinBtn');

    // pin state from localStorage
    const pinned = localStorage.getItem('sidebar_pinned') === '1';
    if (pinned) sidebar.classList.add('open','pinned');

    if(mobileBtn && sidebar) {
      mobileBtn.addEventListener('click', ()=> sidebar.classList.toggle('open'));
      main.addEventListener('click', ()=> { 
        if(window.innerWidth <= 900 && sidebar.classList.contains('open') && !sidebar.classList.contains('pinned')) sidebar.classList.remove('open'); 
      });
    }

    // sidebar tab opens/closes sidebar
    if (sidebarTab) {
      sidebarTab.addEventListener('click', ()=> sidebar.classList.toggle('open'));
    }
    
    // pin/unpin sidebar
    if (sidebarPinBtn) {
      const setPinned = (state) => {
        if (state) {
          sidebar.classList.add('pinned','open');
          localStorage.setItem('sidebar_pinned','1');
          sidebarPinBtn.textContent = '📌';
        } else {
          sidebar.classList.remove('pinned');
          localStorage.removeItem('sidebar_pinned');
          sidebarPinBtn.textContent = '📌';
        }
      };
      sidebarPinBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const nowPinned = sidebar.classList.contains('pinned');
        setPinned(!nowPinned);
      });
      // initialize pin button state
      if (pinned) sidebarPinBtn.classList.add('active');
    }

  })();

  // Logout
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) logoutBtn.addEventListener('click', () => window.location.href = '../index.html');

  // debounce helper para search
  function debounce(fn, wait) {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(()=> fn(...args), wait); };
  }

  // limpiar filtros
  if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', () => {
    if (filterSelect) filterSelect.value = 'all';
    if (searchInput) searchInput.value = '';
    renderClients();
  });

  if (filterSelect) filterSelect.addEventListener('change', () => renderClients());
  if (searchInput) searchInput.addEventListener('input', debounce(()=> renderClients(), 250));
</script>
</body>
</html>
