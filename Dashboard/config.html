<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuraci√≥n - Amelo Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- A√±adido: estilos responsive para sidebar (igual que mainboard) -->
  <style>
    #sidebar { transition: transform .25s ease; }
    @media (max-width: 900px) {
      #sidebar { transform: translateX(-100%); position: fixed; left:0; top:0; bottom:0; z-index:40;}
      #sidebar.open { transform: translateX(0); }
      #sidebar.pinned { transform: translateX(0); }
      #mainContent { margin-left: 0 !important; padding: 1rem !important; }
      .mobile-tap { padding: 12px; font-size: 16px; z-index:10003; } /* a√±adido z-index global */
    }
    .sidebar-tab {
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      background: #0f172a;
      color: #fff;
      width: 42px;
      height: 88px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-top-right-radius: 10px;
      border-bottom-right-radius: 10px;
      z-index: 10002;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .sidebar-pin-btn { background: transparent; border: none; color: inherit; cursor: pointer; font-size: 18px; }

    /* Overlay m√≥vil */
    #sidebarOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 30;
      display: none;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">

<aside id="sidebar" class="w-64 bg-white h-screen shadow-md fixed">
  <div class="p-6 text-2xl font-bold text-blue-600 flex items-center justify-between">
    <span>Amelo Studio</span>
    <button id="sidebarPinBtn" class="sidebar-pin-btn" title="Fijar men√∫">üìå</button>
  </div>
  <nav class="mt-10">
    <a href="mainboard.html" class="nav-link block py-2.5 px-4 rounded hover:bg-blue-100" data-href="mainboard.html">Dashboard</a>
    <a href="calendar.html" class="nav-link block py-2.5 px-4 rounded hover:bg-blue-100" data-href="calendar.html">Calendario</a>
    <a href="configuracion.html" class="nav-link block py-2.5 px-4 rounded bg-blue-100 font-semibold text-blue-700" data-href="configuracion.html">Configuraci√≥n</a>
  </nav>
</aside>

<!-- Overlay m√≥vil -->
<div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-30 md:hidden"></div>

<button id="sidebarTab" class="sidebar-tab md:hidden" aria-label="Abrir men√∫">‚ò∞</button>

<div id="mainContent" class="ml-64 p-8">
  <header class="flex justify-between items-center mb-8">
    <div class="flex items-center gap-4">
      <button id="mobileMenuBtn" class="md:hidden p-2 rounded bg-gray-100 mobile-tap" aria-label="Abrir men√∫">‚ò∞</button>
      <h1 class="text-3xl font-bold text-gray-700">Configuraci√≥n</h1>
    </div>
    <div>
      <span class="mr-4 font-medium" id="currentUserDisplay">Admin</span>
      <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Cerrar sesi√≥n</button>
    </div>
  </header>

  <!-- Usuarios -->
  <section class="bg-white p-6 rounded shadow mb-8">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-semibold text-gray-700">Usuarios</h2>
      <button id="addUserBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">+ Agregar Usuario</button>
    </div>
    <table class="w-full text-left border-collapse">
      <thead>
        <tr class="bg-gray-100 border-b">
          <th class="py-2 px-4">Usuario</th>
          <th class="py-2 px-4 text-right">Acciones</th>
        </tr>
      </thead>
      <tbody id="userTable"></tbody>
    </table>
  </section>

  <!-- Nuevo: Gastos -->
  <section id="expensesSection" class="bg-white p-6 rounded shadow mb-8">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-semibold text-gray-700">Gastos</h2>
      <button id="addExpenseBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">+ Agregar Gasto</button>
    </div>

    <!-- Form inline (oculto por defecto) -->
    <form id="expenseForm" class="hidden flex-col gap-3 mb-4">
      <div class="flex flex-col md:flex-row gap-2">
        <input id="expenseDesc" type="text" placeholder="Concepto" class="p-2 border rounded flex-1" required>
        <input id="expenseAmount" type="number" step="0.01" min="0" placeholder="Monto" class="p-2 border rounded w-40" required>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" id="cancelExpense" class="px-4 py-2 rounded bg-gray-200">Cancelar</button>
        <button type="submit" class="px-4 py-2 rounded bg-red-500 text-white">Guardar Gasto</button>
      </div>
    </form>

    <div class="overflow-y-auto max-h-56">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-gray-100 border-b">
            <th class="py-2 px-4">Fecha</th>
            <th class="py-2 px-4">Concepto</th>
            <th class="py-2 px-4 text-right">Monto</th>
            <th class="py-2 px-4 text-right">Acciones</th>
          </tr>
        </thead>
        <tbody id="expensesTable"></tbody>
      </table>
    </div>
  </section>


<!-- Modal Agregar Usuario -->
<div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
  <div class="bg-white p-6 rounded shadow-lg w-96">
    <h2 class="text-xl font-semibold mb-4">Agregar Usuario</h2>
    <form id="addUserForm" class="flex flex-col gap-3">
      <input type="text" id="newUsername" placeholder="Nombre de usuario" class="p-2 border rounded" required>
      
      <label class="flex items-center gap-2">
        Rol:
        <select id="newUserRole" class="p-2 border rounded">
          <option value="worker" selected>Worker</option>
          <option value="admin">Admin</option>
        </select>
      </label>
      
      <div class="flex justify-end gap-2 mt-2">
        <button type="button" id="closeUserModal" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancelar</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
  // --- Configuraci√≥n Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyBnIUBoaMViSI2jHGPD9NoJaJrTQiL-UFU",
    authDomain: "amelos-studio.firebaseapp.com",
    databaseURL: "https://amelos-studio-default-rtdb.firebaseio.com",
    projectId: "amelos-studio",
    storageBucket: "amelos-studio.firebasestorage.app",
    messagingSenderId: "11496902615",
    appId: "1:11496902615:web:33ce1c36199e7c17be8592",
    measurementId: "G-DR054GPPZF"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // --- Elementos del DOM ---
  const addUserBtn = document.getElementById('addUserBtn');
  const addUserModal = document.getElementById('addUserModal');
  const closeUserModal = document.getElementById('closeUserModal');
  const addUserForm = document.getElementById('addUserForm');
  const userTable = document.getElementById('userTable');

  const editPasswordBtn = document.getElementById('editPasswordBtn');
  const savePasswordBtn = document.getElementById('savePasswordBtn');
  const globalPassword = document.getElementById('globalPassword');

  const logoutBtn = document.getElementById('logoutBtn');
  const currentUserDisplay = document.getElementById('currentUserDisplay');

  // --- Usuario logueado (simulaci√≥n, se debe reemplazar por sesi√≥n real) ---
  let currentUser = { username: 'Elian', role: 'admin' }; // Cambiar seg√∫n autenticaci√≥n
  currentUserDisplay.textContent = currentUser.username + ' (' + currentUser.role + ')';

  // --- Mostrar modal ---
  addUserBtn.addEventListener('click', () => {
    addUserModal.classList.remove('hidden');
    addUserModal.classList.add('flex');
  });

  closeUserModal.addEventListener('click', () => {
    addUserModal.classList.add('hidden');
    addUserModal.classList.remove('flex');
  });

  // --- Funciones Firebase ---
  function renderUsers(data) {
    userTable.innerHTML = '';
    for (const id in data) {
      const user = data[id];
      const isAdmin = user.role === 'admin';
      const row = document.createElement('tr');
      row.classList.add('border-b');
      row.innerHTML = `
        <td class="py-2 px-4 ${isAdmin ? 'font-medium text-gray-800' : 'text-gray-700'}">
          ${user.username} (${user.role})
        </td>
        <td class="py-2 px-4 text-right">
          ${currentUser.role === 'admin' && !isAdmin 
            ? `<button class="text-red-500 hover:underline delete-user" data-id="${id}">Eliminar</button>` 
            : (isAdmin ? '<span class="text-gray-500 italic">No se puede eliminar</span>' : '')}
        </td>
      `;
      userTable.appendChild(row);
    }
  }

  // Cargar usuarios
  db.ref('usuarios').on('value', snapshot => {
    if(snapshot.exists()) {
      renderUsers(snapshot.val());
    }
  });

  // Agregar usuario
  addUserForm.addEventListener('submit', e => {
    e.preventDefault();
    const username = document.getElementById('newUsername').value.trim();
    const role = document.getElementById('newUserRole').value;
    if(!username) return;

    db.ref('usuarios').push({ username, password: 'ameyelo16', role });
    addUserForm.reset();
    addUserModal.classList.add('hidden');
    addUserModal.classList.remove('flex');
  });

  // Eliminar usuario
  document.addEventListener('click', e => {
    if(e.target.classList.contains('delete-user')) {
      const id = e.target.getAttribute('data-id');
      if(id) db.ref('usuarios/' + id).remove();
    }
  });

  // --- Contrase√±a Global ---
  if (globalPassword) {
    db.ref('globalPassword').on('value', snapshot => {
      if(snapshot.exists()) globalPassword.value = snapshot.val();
    });
  }

  editPasswordBtn?.addEventListener('click', () => {
    if(currentUser.role !== 'admin') return;
    if (globalPassword) globalPassword.removeAttribute('disabled');
    savePasswordBtn?.classList.remove('hidden');
    editPasswordBtn?.classList.add('hidden');
  });

  document.getElementById('passwordForm')?.addEventListener('submit', e => {
    e.preventDefault();
    if(currentUser.role !== 'admin') return;
    if (globalPassword) db.ref('globalPassword').set(globalPassword.value);
    if (globalPassword) globalPassword.setAttribute('disabled', true);
    savePasswordBtn?.classList.add('hidden');
    editPasswordBtn?.classList.remove('hidden');
    alert('Contrase√±a actualizada exitosamente.');
  });

  // --- Permisos para botones seg√∫n rol ---
  function updatePermissions() {
    if(currentUser.role !== 'admin') {
      if (editPasswordBtn) {
        editPasswordBtn.setAttribute('disabled', true);
        editPasswordBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }
  }
  updatePermissions();

  // --- Expenses (Gastos) ---
  const addExpenseBtn = document.getElementById('addExpenseBtn');
  const expenseForm = document.getElementById('expenseForm');
  const cancelExpense = document.getElementById('cancelExpense');
  const expenseDesc = document.getElementById('expenseDesc');
  const expenseAmount = document.getElementById('expenseAmount');
  const expensesTable = document.getElementById('expensesTable');

  const expensesRef = db.ref('expenses');

  // Mostrar formulario (solo admin)
  function updateExpenseUIPermissions() {
    if (!currentUser || currentUser.role !== 'admin') {
      addExpenseBtn.setAttribute('disabled', 'true');
      addExpenseBtn.classList.add('opacity-50','cursor-not-allowed');
    } else {
      addExpenseBtn.removeAttribute('disabled');
      addExpenseBtn.classList.remove('opacity-50','cursor-not-allowed');
    }
  }
  updateExpenseUIPermissions();

  addExpenseBtn?.addEventListener('click', () => {
    if (currentUser.role !== 'admin') return;
    expenseForm.classList.remove('hidden');
    expenseForm.classList.add('flex');
    expenseDesc.focus();
  });
  cancelExpense?.addEventListener('click', () => {
    expenseForm.classList.add('hidden');
    expenseForm.classList.remove('flex');
    expenseForm.reset?.();
  });

  // Guardar gasto en Firebase
  expenseForm?.addEventListener('submit', e => {
    e.preventDefault();
    if (currentUser.role !== 'admin') return;
    const desc = (expenseDesc.value || '').trim();
    const amount = parseFloat(expenseAmount.value) || 0;
    if (!desc || amount <= 0) return;
    const expense = {
      description: desc,
      amount: amount,
      createdAt: Date.now(),
      createdBy: currentUser.username
    };
    expensesRef.push(expense);
    // limpiar UI
    expenseForm.reset();
    expenseForm.classList.add('hidden');
    expenseForm.classList.remove('flex');
  });

  // Renderizar gastos en lista
  function renderExpenses(data) {
    expensesTable.innerHTML = '';
    if (!data) return;
    // convertir objeto a array con key
    const rows = Object.keys(data).map(k => ({ key: k, ...data[k] }))
      .sort((a,b)=> b.createdAt - a.createdAt);
    for (const item of rows) {
      const tr = document.createElement('tr');
      tr.classList.add('border-b');
      const date = new Date(item.createdAt).toLocaleString();
      const canDelete = currentUser.role === 'admin';
      tr.innerHTML = `
        <td class="py-2 px-4">${date}</td>
        <td class="py-2 px-4">${item.description}</td>
        <td class="py-2 px-4 text-right">$${(item.amount||0).toFixed(2)}</td>
        <td class="py-2 px-4 text-right">
          ${canDelete ? `<button class="text-red-500 hover:underline delete-expense" data-key="${item.key}">Eliminar</button>` : ''}
        </td>
      `;
      expensesTable.appendChild(tr);
    }
  }

  // Escuchar cambios en expenses
  expensesRef.on('value', snapshot => {
    const val = snapshot.exists() ? snapshot.val() : null;
    renderExpenses(val);
  });

  // Eliminar gasto (solo admin)
  document.addEventListener('click', e => {
    if (e.target.classList.contains('delete-expense')) {
      if (currentUser.role !== 'admin') return;
      const key = e.target.getAttribute('data-key');
      if (!key) return;
      if (confirm('¬øEliminar este gasto?')) expensesRef.child(key).remove();
    }
  });

  // Logout
  logoutBtn?.addEventListener('click', () => {
    window.location.href = '../index.html';
  });

  /* A√±adido: script para manejar sidebar m√≥vil y pin (comportamiento igual que mainboard) */
  (function(){
    const mobileBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('sidebar');
    const main = document.getElementById('mainContent');
    const sidebarTab = document.getElementById('sidebarTab');
    const sidebarPinBtn = document.getElementById('sidebarPinBtn');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    // pin state from localStorage
    const pinned = localStorage.getItem('sidebar_pinned') === '1';
    if (pinned && sidebar) sidebar.classList.add('open','pinned');

    function openSidebar() {
      if (!sidebar) return;
      sidebar.classList.add('open');
      sidebarOverlay?.classList.remove('hidden');
    }
    function closeSidebar() {
      if (!sidebar) return;
      if (!sidebar.classList.contains('pinned')) sidebar.classList.remove('open');
      sidebarOverlay?.classList.add('hidden');
    }
    function toggleSidebar() {
      if (!sidebar) return;
      if (sidebar.classList.contains('open')) closeSidebar();
      else openSidebar();
    }

    if (mobileBtn) {
      mobileBtn.addEventListener('click', toggleSidebar);
      mobileBtn.addEventListener('touchstart', (e) => { e.preventDefault(); toggleSidebar(); }, {passive:false});
    }
    if (sidebarTab) {
      sidebarTab.addEventListener('click', toggleSidebar);
      sidebarTab.addEventListener('touchstart', (e) => { e.preventDefault(); toggleSidebar(); }, {passive:false});
    }
    sidebarOverlay?.addEventListener('click', closeSidebar);
    sidebarOverlay?.addEventListener('touchstart', (e)=> { e.preventDefault(); closeSidebar(); }, {passive:false});

    if (main) {
      main.addEventListener('click', ()=> {
        if (window.innerWidth <= 900 && sidebar && sidebar.classList.contains('open') && !sidebar.classList.contains('pinned')) closeSidebar();
      });
    }

    // cerrar sidebar al clicar en cualquier enlace de navegaci√≥n en mobile
    const navLinks = document.querySelectorAll('#sidebar .nav-link');
    navLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth < 768) closeSidebar();
      });
    });

    if (sidebarPinBtn) {
      const setPinned = (state) => {
        if (!sidebar) return;
        if (state) {
          sidebar.classList.add('pinned','open');
          localStorage.setItem('sidebar_pinned','1');
        } else {
          sidebar.classList.remove('pinned');
          localStorage.removeItem('sidebar_pinned');
        }
      };
      sidebarPinBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const nowPinned = sidebar.classList.contains('pinned');
        setPinned(!nowPinned);
      });
    }
  })();
</script>

</body>
</html>
